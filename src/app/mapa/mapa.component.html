<div class="install-banner" *ngIf="installPrompt && showInstallBanner">
  <div class="install-banner-content">
    <mat-icon>add_to_home_screen</mat-icon>
    <div class="install-banner-text">
      <strong>Instale o Pão Quentinho!</strong>
      <span>Acesse mais rápido, direto da sua tela inicial.</span>
    </div>
    <button mat-flat-button color="primary" (click)="instalarPWA()">Instalar</button>
    <button mat-icon-button (click)="dismissInstallBanner()" aria-label="Dispensar instalação">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<!-- Tour Guiado para Novos Usuários -->
<div class="tour-overlay" *ngIf="tourStep">
  <!-- Passo 1: Permissão de Localização -->
  <div class="tour-step" *ngIf="tourStep === 'location'">
    <div class="tour-content">
      <mat-icon class="tour-icon">location_on</mat-icon>
      <h2 class="tour-title">Encontre pão quentinho perto de você</h2>
      <p class="tour-description">Para mostrar as padarias e confeitarias próximas, precisamos acessar sua localização.</p>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="solicitarPermissaoLocalizacao()">Permitir localização</button>
      <button mat-button (click)="avancarTour(true)">Pular</button>
    </div>
  </div>

  <!-- Passo 2: Permissão de Notificação -->
  <div class="tour-step" *ngIf="tourStep === 'notification'">
    <div class="tour-content">
      <mat-icon class="tour-icon">notifications_active</mat-icon>
      <h2 class="tour-title">Receba alertas de fornadas!</h2>
      <p class="tour-description">Seja o primeiro a saber quando o pão quentinho sair. Ative as notificações para receber nossos alertas.</p>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="solicitarPermissaoNotificacao()">Ativar notificações</button>
      <button mat-button (click)="avancarTour(true)">Agora não</button>
    </div>
  </div>

  <!-- Passo 3: Cadastro/Login -->
  <div class="tour-step" *ngIf="tourStep === 'login'">
    <div class="tour-content auth-form-container">
      <mat-icon class="tour-icon">account_circle</mat-icon>
      <h2 class="tour-title">Crie sua conta ou entre</h2>
      <p class="tour-description">Salve seus locais favoritos e receba alertas personalizados de fornadas.</p>

      <mat-tab-group #tabGroup mat-stretch-tabs="false" animationDuration="0ms" class="auth-tabs" (selectedIndexChange)="activeTabIndex = $event">
        <mat-tab label="Cadastrar">
          <form [formGroup]="registerForm" (ngSubmit)="onRegister()" class="auth-form" id="registerForm">
            <mat-form-field appearance="outline">
              <mat-label>Nome</mat-label>
              <input matInput formControlName="name" required>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput formControlName="email" type="email" required>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Senha</mat-label>
              <input matInput formControlName="password" [type]="hideRegisterPassword ? 'password' : 'text'" required>
              <button mat-icon-button matSuffix (click)="hideRegisterPassword = !hideRegisterPassword" type="button" [attr.aria-label]="'Esconder senha'" [attr.aria-pressed]="hideRegisterPassword">
                <mat-icon>{{hideRegisterPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
              <mat-error *ngIf="registerForm.get('password')?.hasError('required')">A senha é obrigatória.</mat-error>
              <mat-error *ngIf="registerForm.get('password')?.hasError('minlength')">A senha deve ter no mínimo 8 caracteres.</mat-error>
              <mat-error *ngIf="registerForm.get('password')?.hasError('pattern')">A senha deve conter letras e números.</mat-error>
            </mat-form-field>
            <mat-checkbox formControlName="isLojista" class="lojista-checkbox">Sou lojista e quero cadastrar meu estabelecimento</mat-checkbox>
            <div *ngIf="registerErrorMessage" class="error-message">
              <mat-icon>error_outline</mat-icon>
              <span>{{ registerErrorMessage }}</span>
            </div>
          </form>
        </mat-tab>
        <mat-tab label="Entrar">
          <form [formGroup]="loginForm" (ngSubmit)="onLogin()" class="auth-form" id="loginForm">
            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput formControlName="email" type="email" required>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Senha</mat-label>
              <input matInput formControlName="password" [type]="hideLoginPassword ? 'password' : 'text'" required>
              <button mat-icon-button matSuffix (click)="hideLoginPassword = !hideLoginPassword" type="button" [attr.aria-label]="'Esconder senha'" [attr.aria-pressed]="hideLoginPassword">
                <mat-icon>{{hideLoginPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
            </mat-form-field>
            <div *ngIf="loginErrorMessage" class="error-message">
              <mat-icon>error_outline</mat-icon>
              <span>{{ loginErrorMessage }}</span>
            </div>
          </form>
        </mat-tab>
      </mat-tab-group>
    </div>
    <div class="tour-actions">
      <!-- Botões de submit para os formulários -->
      <button mat-flat-button color="primary" type="submit" form="registerForm" [disabled]="isRegistering || registerForm.invalid" *ngIf="activeTabIndex === 0" class="auth-button">
        <span *ngIf="!isRegistering">Cadastrar</span>
        <mat-spinner *ngIf="isRegistering" diameter="24"></mat-spinner>
      </button>
      <button mat-flat-button color="primary" type="submit" form="loginForm" [disabled]="isLoggingIn || loginForm.invalid" *ngIf="activeTabIndex === 1" class="auth-button">
        <span *ngIf="!isLoggingIn">Entrar</span>
        <mat-spinner *ngIf="isLoggingIn" diameter="24"></mat-spinner>
      </button>
      
      <button mat-button (click)="avancarTour(true)" class="skip-button">Pular por enquanto</button>
    </div>
  </div>

  <!-- Passo 4: Instalar o App -->
  <div class="tour-step" *ngIf="tourStep === 'install' && installPrompt">
    <div class="tour-content">
      <mat-icon class="tour-icon">add_to_home_screen</mat-icon>
      <h2 class="tour-title">Instale o Pão Quentinho!</h2>
      <p class="tour-description">Tenha acesso rápido ao app, direto da sua tela inicial, para uma melhor experiência.</p>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="instalarPWA()">Instalar App</button>
      <button mat-button (click)="finalizarTour()">Depois</button>
    </div>
  </div>
</div>


<div class="map-container">
  <!-- Cabeçalho Flutuante -->
  <div class="floating-header">
    <!-- Caixa de Busca -->
    <mat-form-field appearance="outline" class="search-input" subscriptSizing="dynamic">
      <input matInput [formControl]="searchControl" (keyup.enter)="buscarEndereco()" placeholder="Buscar por Endereço ou CEP">
      <button mat-icon-button matSuffix (click)="buscarEndereco()" aria-label="Buscar">
        <mat-icon>search</mat-icon>
      </button>
    </mat-form-field>

    <!-- Botão de Localização -->
    <button mat-icon-button (click)="centralizarNoUsuario()" matTooltip="Usar minha localização atual" class="location-button">
      <mat-icon>my_location</mat-icon>
    </button>

    <!-- Botão de Conta/Menu -->
    <button mat-icon-button [matMenuTriggerFor]="userMenu" class="account-button" matTooltip="Minha Conta">
      <mat-icon>account_circle</mat-icon>
    </button>
  </div>
  
  <!-- Overlay de Carregamento -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="50" aria-label="Carregando"></mat-progress-spinner>
    <p class="loading-text">Localizando você e buscando os melhores pães...</p>
  </div>


  <div #map id="map"></div>

  <mat-button-toggle-group class="radius-filter" [value]="raio" (change)="definirRaio($event.value)" *ngIf="!routingControl">
    <mat-button-toggle [value]="500">500m</mat-button-toggle>
    <mat-button-toggle [value]="1000">1km</mat-button-toggle>
    <mat-button-toggle [value]="5000">5km</mat-button-toggle>
  </mat-button-toggle-group>

  <!-- Nova UI de Navegação -->
  <div class="navigation-ui-container" *ngIf="routingControl">
    <!-- Card de Rota no Rodapé -->
    <mat-card class="route-card">
      <mat-card-content>
        <button mat-icon-button class="back-button-card" (click)="fecharDetalhe()" matTooltip="Sair da rota">
          <mat-icon>close</mat-icon>
        </button>
        <div class="route-info">
          <span>Rota para <b>{{ selectedEstabelecimento?.nome }}</b></span>
        </div>
        <button mat-flat-button color="primary" class="gps-button" (click)="abrirNoGPS()">
          Abrir no GPS
        </button>
      </mat-card-content>
    </mat-card>
  </div>

</div>

<!-- Menu do Usuário -->
<mat-menu #userMenu="matMenu">
  <ng-container *ngIf="authService.authState$ | async; else loggedOutMenu">
    <div class="menu-header" *ngIf="(authService.currentUser$ | async) as user">
      <div class="user-name" *ngIf="user.name">{{ user.name }}</div>
      <div class="user-email">{{ user.email }}</div>
    </div>
    <mat-divider *ngIf="authService.authState$ | async"></mat-divider>

    <button mat-menu-item (click)="navigateTo(['/meus-estabelecimentos'])" *ngIf="isLojista">
      <mat-icon>storefront</mat-icon>
      <span>Meus Estabelecimentos</span>
    </button>
    <button mat-menu-item (click)="navigateTo(['/minhas-inscricoes'])" *ngIf="!isLojista">
      <mat-icon>notifications</mat-icon>
      <span>Minhas Inscrições</span>
    </button>
    <button mat-menu-item (click)="abrirLinkDeAjuda()">
      <mat-icon>help_outline</mat-icon>
      <span>Preciso de ajuda</span>
    </button>
    <button mat-menu-item (click)="authService.logout()">
      <mat-icon>logout</mat-icon>Sair
    </button>
  </ng-container>
  <ng-template #loggedOutMenu><button mat-menu-item (click)="authService.requestLogin()">Entrar / Cadastrar</button></ng-template>
</mat-menu>
<!-- Bottom Sheet customizado -->
<div
  id="bottomSheet"
  [class.open]="isListOpen"
  *ngIf="!routingControl && !isLoading"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd($event)"
>
  <div class="handle" (click)="alternarLista()">
    <div class="handle-bar"></div>
  </div>
  <div class="sheet-content">
    <h4 class="sheet-title" *ngIf="estabelecimentosVisiveis.length > 0; else noResults">
      Exibindo {{ estabelecimentosVisiveis.length }} de {{ todosEstabelecimentos.length }} locais
    </h4>
    <ng-template #noResults>
      <h4 class="sheet-title">Nenhum local encontrado neste raio.</h4>
    </ng-template>
    <mat-nav-list>
      <a mat-list-item *ngFor="let est of estabelecimentosVisiveis" (click)="selecionarEstabelecimento(est)" class="establishment-list-item">
        <mat-icon matListItemIcon class="list-item-icon">
          @switch (est.tipo) {
            @case ('padaria') { bakery_dining }
            @case ('confeitaria') { cake }
            @case ('doceria') { icecream }
            @default { storefront }
          }
        </mat-icon>
        <div matListItemTitle class="list-item-title">{{ est.nome }}</div>
        <div matListItemLine class="list-item-line">{{ est.tipo }}</div>
        <span class="list-item-spacer"></span>
        <div matListItemMeta class="distancia-meta">{{ (est.distanciaKm ?? 0).toFixed(2) }} km</div>
      </a>
    </mat-nav-list>
  </div>
</div>

<!-- Card de Detalhes do Estabelecimento -->
<div class="establishment-details-container" *ngIf="selectedEstabelecimento && !routingControl" (click)="fecharDetalhe()">
  <mat-card class="establishment-card" (click)="$event.stopPropagation()">
    <mat-card-header>
      <div class="header-text-content">
        <mat-card-title>{{ selectedEstabelecimento.nome }}</mat-card-title>
        <mat-card-subtitle>{{ selectedEstabelecimento.endereco.bairro }} - {{ (selectedEstabelecimento.distanciaKm ?? 0).toFixed(2) }} km</mat-card-subtitle>
      </div>
      <button mat-icon-button class="header-share-button" (click)="compartilharEstabelecimento(selectedEstabelecimento, $event)" matTooltip="Compartilhar este local">
        <mat-icon>share</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content>

      <!-- Informações -->
      <p class="info-text">{{ selectedEstabelecimento.info }}</p>
       <!-- Horário de Funcionamento -->
      <div class="horario-highlight" *ngIf="getHorarioHoje(selectedEstabelecimento) as horarioHoje">
        <mat-icon class="horario-icon">schedule</mat-icon>
        <span>{{ horarioHoje }}</span>
      </div>

      <!-- Destaque da Próxima Fornada -->
      <ng-container *ngIf="getHorarioHoje(selectedEstabelecimento) as horarioHoje">
        <div class="fornada-highlight" *ngIf="!horarioHoje.toLowerCase().includes('fechado')">
          <mat-icon>bakery_dining</mat-icon>
          <span>Próxima fornada quentinha às <b>{{ getNextFornada(selectedEstabelecimento.proximaFornada) }}</b></span>
        </div>
      </ng-container>
      
      <!-- Endereço Clicável -->
      <a class="address-container" (click)="iniciarNavegacao(selectedEstabelecimento, $event)" mat-ripple>
        <div class="address-content">
          <mat-icon class="location-icon">location_on</mat-icon>
          <div class="address-text">
            <p>{{ selectedEstabelecimento.endereco.rua }}, {{ selectedEstabelecimento.endereco.numero }}</p>
            <small>Toque para ver a rota</small>
          </div>
        </div>
        <mat-icon>chevron_right</mat-icon>
      </a>

    </mat-card-content>
    <mat-card-actions class="card-actions-wrapper">
      <button mat-flat-button color="primary" class="follow-button" (click)="seguirEstabelecimento(selectedEstabelecimento, $event)">
        <mat-icon>notifications</mat-icon>
        Seguir e receber alertas
      </button>
      <button mat-button class="close-button" (click)="fecharDetalhe()">Fechar</button>
    </mat-card-actions>
  </mat-card>
</div>
