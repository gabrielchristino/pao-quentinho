<div class="install-banner" *ngIf="installPrompt && showInstallBanner">
  <div class="install-banner-content">
    <mat-icon>add_to_home_screen</mat-icon>
    <div class="install-banner-text">
      <strong>Instale o Pão Quentinho!</strong>
      <span>Acesse mais rápido, direto da sua tela inicial.</span>
    </div>
    <button mat-flat-button color="primary" (click)="instalarPWA()">Instalar</button>
    <button mat-icon-button (click)="dismissInstallBanner($event)" aria-label="Dispensar instalação">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<div class="tour-overlay" *ngIf="tourStep">
  <div class="tour-step" *ngIf="tourStep === 'welcome'">
    <div class="tour-content">
      <video #videoPlayer autoplay [muted]="true" playsinline width="90%" class="welcome-video">
        <source src="assets/videos/inicio.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
      </video>
      <h2 class="tour-title">Bem-vindo ao Pão Quentinho!</h2>
      <div class="welcome-text">
        <p>Nosso aplicativo conecta você às melhores padarias, confeitarias e mercados da sua região.</p>
        <p>Encontre <strong>em tempo real pão quentinho</strong> e outras delícias recém-saídas do forno.</p>
        <p>Siga seus locais favoritos e <strong>receba alertas de novas fornadas</strong>.</p>
      </div>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="avancarTour()" class="auth-button">Começar</button>
    </div>
  </div>

  <div class="tour-step" *ngIf="tourStep === 'location'">
    <div class="tour-content">
      <video #videoPlayer autoplay loop [muted]="true" playsinline width="90%" class="welcome-video location-video">
        <source src="assets/videos/location.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
      </video>
      <h2 class="tour-title">Encontre pão perto de você</h2>
      <p class="tour-description">Para mostrar as padarias e confeitarias próximas, precisamos acessar sua localização.
      </p>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="solicitarPermissaoLocalizacao()"
        [disabled]="isRequestingLocation" class="auth-button">
        <span *ngIf="!isRequestingLocation">Permitir localização</span>
        <mat-spinner *ngIf="isRequestingLocation" diameter="24"></mat-spinner>
      </button>
      <button mat-button (click)="avancarTour(true)" class="skip-button">Pular</button>
    </div>
  </div>

  <div class="tour-step" *ngIf="tourStep === 'notification'">
    <div class="tour-content">
      <video #videoPlayer autoplay loop [muted]="true" playsinline class="welcome-video notification-video" width="90%">
        <source src="assets/videos/notification.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
      </video>
      <h2 class="tour-title">Receba alertas de fornadas!</h2>
      <p class="tour-description">Seja o primeiro a saber quando o pão quentinho sair. Ative as notificações para
        receber nossos alertas.</p>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="solicitarPermissaoNotificacao()"
        [disabled]="isRequestingNotification" class="auth-button">
        <span *ngIf="!isRequestingNotification">Ativar notificações</span>
        <mat-spinner *ngIf="isRequestingNotification" diameter="24"></mat-spinner>
      </button>
      <button mat-button (click)="avancarTour(true)" class="skip-button">Agora não</button>
    </div>
  </div>

  <div class="tour-step" *ngIf="tourStep === 'login'">
    <div class="tour-content auth-form-container">
      <video #avatarVideo [muted]="true" playsinline preload="auto" width="90%" class="welcome-video login-video">
        <source src="assets/videos/login.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
      </video>
      <h2 class="tour-title">Crie sua conta ou entre</h2>
      <p class="tour-description" style="margin-bottom: 0;">Acompanhe suas fornadas favoritas.</p>

      <mat-tab-group #tabGroup mat-stretch-tabs="false" animationDuration="0ms" class="auth-tabs"
        (selectedIndexChange)="activeTabIndex = $event">

        <mat-tab label="Cadastrar">
          <form [formGroup]="registerForm" (ngSubmit)="onRegister()" class="auth-form" id="registerForm">
            <mat-form-field appearance="outline">
              <mat-label>Nome</mat-label>
              <input matInput formControlName="name" required (focus)="playAction('olharBaixo')"
                (blur)="playAction('idle')">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput formControlName="email" type="email" required (focus)="playAction('olharBaixo')"
                (blur)="playAction('idle')">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Senha</mat-label>
              <input matInput formControlName="password" [type]="hideRegisterPassword ? 'password' : 'text'" required
                (focus)="playAction('cobrirOlhos')" (blur)="playAction('idle')">
              <button mat-icon-button matSuffix (click)="hideRegisterPassword = !hideRegisterPassword" type="button"
                [attr.aria-label]="'Esconder senha'" [attr.aria-pressed]="hideRegisterPassword">
                <mat-icon>{{hideRegisterPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
              <mat-error *ngIf="registerForm.get('password')?.hasError('required')">A senha é obrigatória.</mat-error>
              <mat-error *ngIf="registerForm.get('password')?.hasError('minlength')">Mínimo 8 caracteres.</mat-error>
              <mat-error *ngIf="registerForm.get('password')?.hasError('pattern')">Letras e números.</mat-error>
            </mat-form-field>

            <mat-checkbox formControlName="isLojista" class="lojista-checkbox">Sou lojista e quero cadastrar meu
              estabelecimento</mat-checkbox>

            <div *ngIf="registerErrorMessage" class="error-message">
              <mat-icon>error_outline</mat-icon>
              <span>{{ registerErrorMessage }}</span>
            </div>
          </form>
        </mat-tab>

        <mat-tab label="Entrar">
          <form [formGroup]="loginForm" (ngSubmit)="onLogin()" class="auth-form" id="loginForm">
            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput formControlName="email" type="email" required (focus)="playAction('olharBaixo')"
                (blur)="playAction('idle')">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Senha</mat-label>
              <input matInput formControlName="password" [type]="hideLoginPassword ? 'password' : 'text'" required
                (focus)="playAction('cobrirOlhos')" (blur)="playAction('idle')">
              <button mat-icon-button matSuffix (click)="hideLoginPassword = !hideLoginPassword" type="button"
                [attr.aria-label]="'Esconder senha'" [attr.aria-pressed]="hideLoginPassword">
                <mat-icon>{{hideLoginPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
              </button>
            </mat-form-field>
            <div *ngIf="loginErrorMessage" class="error-message">
              <mat-icon>error_outline</mat-icon>
              <span>{{ loginErrorMessage }}</span>
            </div>
          </form>
        </mat-tab>
      </mat-tab-group>
    </div>

    <div class="tour-actions">
      <button mat-flat-button color="primary" type="submit" form="registerForm"
        [disabled]="isRegistering || registerForm.invalid" *ngIf="activeTabIndex === 0" class="auth-button">
        <span *ngIf="!isRegistering">Cadastrar</span>
        <mat-spinner *ngIf="isRegistering" diameter="24"></mat-spinner>
      </button>
      <button mat-flat-button color="primary" type="submit" form="loginForm"
        [disabled]="isLoggingIn || loginForm.invalid" *ngIf="activeTabIndex === 1" class="auth-button">
        <span *ngIf="!isLoggingIn">Entrar</span>
        <mat-spinner *ngIf="isLoggingIn" diameter="24"></mat-spinner>
      </button>

      <button mat-button (click)="avancarTour()" class="skip-button">Pular por enquanto</button>
    </div>
  </div>

  <div class="tour-step" *ngIf="tourStep === 'install' && installPrompt">
    <div class="tour-content">
      <mat-icon class="tour-icon">add_to_home_screen</mat-icon>
      <h2 class="tour-title">Instale o Pão Quentinho!</h2>
      <p class="tour-description">Tenha acesso rápido ao app, direto da sua tela inicial, para uma melhor experiência.
      </p>
    </div>
    <div class="tour-actions">
      <button mat-flat-button color="primary" (click)="instalarPWA()" class="auth-button">Instalar App</button>
      <button mat-button (click)="finalizarTour()" class="skip-button">Depois</button>
    </div>
  </div>
</div>

<div class="map-container">
  <div class="floating-header">
    <mat-form-field appearance="outline" class="search-input" subscriptSizing="dynamic">
      <input matInput [formControl]="searchControl" (keyup.enter)="buscarEndereco()"
        placeholder="Buscar por Endereço ou CEP">
      <button mat-icon-button matSuffix (click)="buscarEndereco()" aria-label="Buscar">
        <mat-icon>search</mat-icon>
      </button>
    </mat-form-field>

    <button mat-icon-button (click)="centralizarNoUsuario()" matTooltip="Usar minha localização atual"
      #locationTooltip="matTooltip" matTooltipHideDelay="1000000" class="location-button"
      aria-label="Centralizar na sua localização atual">
      <mat-icon>my_location</mat-icon>
    </button>

    <button mat-icon-button [matMenuTriggerFor]="userMenu" class="account-button" aria-label="Abrir menu da conta">
      <mat-icon>{{ (authService.authState$ | async) ? "face" : "face_retouching_off" }}</mat-icon>
    </button>
  </div>

  <div class="loading-overlay" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="50" aria-label="Carregando"></mat-progress-spinner>
    <p class="loading-text">Localizando você e buscando os melhores pães...</p>
  </div>

  <div #map id="map"></div>

  <mat-button-toggle-group class="radius-filter" [value]="raio" (change)="definirRaio($event.value)"
    *ngIf="!routingControl">
    <mat-button-toggle [value]="500">500m</mat-button-toggle>
    <mat-button-toggle [value]="1000">1km</mat-button-toggle>
    <mat-button-toggle [value]="5000">5km</mat-button-toggle>
  </mat-button-toggle-group>

  <div class="navigation-ui-container" *ngIf="routingControl">
    <mat-card class="route-card">
      <mat-card-content>
        <button mat-icon-button class="back-button-card" (click)="fecharDetalhe()" matTooltip="Sair da rota">
          <mat-icon>close</mat-icon>
        </button>
        <div class="route-info">
          <span>Rota para <br> <b>{{ selectedEstabelecimento?.nome }}</b></span>
        </div>
        <button mat-flat-button color="primary" class="gps-button" (click)="abrirNoGPS()">
          Abrir no GPS
        </button>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<mat-menu #userMenu="matMenu">
  <ng-container *ngIf="authService.authState$ | async; else loggedOutMenu">
    <div class="menu-header" *ngIf="(authService.currentUser$ | async) as user">
      <div class="user-name" *ngIf="user.name">{{ user.name }}</div>
      <div class="user-email">{{ user.email }}</div>
    </div>
    <mat-divider *ngIf="authService.authState$ | async"></mat-divider>
    <button mat-menu-item (click)="navigateTo(['/meus-estabelecimentos'])" *ngIf="isLojista">
      <mat-icon>storefront</mat-icon><span>Meus Estabelecimentos</span>
    </button>
    <button mat-menu-item (click)="navigateTo(['/minhas-inscricoes'])">
      <mat-icon>subscriptions</mat-icon>
      <span>Padarias que sigo</span>
    </button>
    <button mat-menu-item (click)="navigateTo(['/planos'])">
      <mat-icon>card_membership</mat-icon>
      <span>Meus Planos</span>
    </button>
    <button mat-menu-item (click)="navigateTo(['/sobre'])">
      <mat-icon>info_outline</mat-icon><span>Sobre</span>
    </button>
    <button mat-menu-item (click)="navigateTo(['/ajuda'])">
      <mat-icon>help_outline</mat-icon><span>Preciso de ajuda</span>
    </button>
    <button mat-menu-item (click)="authService.logout()">
      <mat-icon>logout</mat-icon>Sair
    </button>
  </ng-container>
  <ng-template #loggedOutMenu><button mat-menu-item (click)="authService.requestLogin()">Entrar /
      Cadastrar</button></ng-template>
</mat-menu>

<div id="bottomSheet" [class.open]="isListOpen" *ngIf="!routingControl && !isLoading"
  (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)">
  <div class="handle" (click)="alternarLista()">
    <div class="handle-bar"></div>
  </div>
  <div class="sheet-content">
    <h4 class="sheet-title" *ngIf="estabelecimentosVisiveis.length > 0; else noResults">
      Exibindo {{ estabelecimentosVisiveis.length }} de {{ todosEstabelecimentos.length }} locais
    </h4>
    <ng-template #noResults>
      <h4 class="sheet-title">Nenhum local encontrado neste raio.</h4>
    </ng-template>
    <mat-nav-list>
      <a mat-list-item *ngFor="let est of estabelecimentosVisiveis" (click)="selecionarEstabelecimento(est)"
        class="establishment-list-item">
        <mat-icon matListItemIcon class="list-item-icon">
          @switch (est.tipo) {
          @case ('padaria') { bakery_dining }
          @case ('confeitaria') { cake }
          @case ('doceria') { icecream }
          @default { storefront }
          }
        </mat-icon>
        <div matListItemTitle class="list-item-title">{{ est.nome }}</div>
        <div matListItemLine class="list-item-line">{{ est.tipo }}</div>
        <span class="list-item-spacer"></span>
        <div matListItemMeta class="distancia-meta">{{ (est.distanciaKm ?? 0).toFixed(2) }} km</div>
      </a>
    </mat-nav-list>
  </div>
</div>

<div class="establishment-details-container" *ngIf="selectedEstabelecimento && !routingControl"
  (click)="fecharDetalhe()">
  <mat-card class="establishment-card" (click)="$event.stopPropagation()">
    <mat-card-header>
      <div class="header-text-content">
        <mat-card-title>{{ selectedEstabelecimento.nome }}</mat-card-title>
        <mat-card-subtitle>{{ selectedEstabelecimento.endereco.bairro }} - {{ (selectedEstabelecimento.distanciaKm ??
          0).toFixed(2) }} km</mat-card-subtitle>
      </div>
      <button mat-icon-button class="header-share-button" (click)="compartilharEstabelecimento($event)"
        matTooltip="Compartilhar este local">
        <mat-icon>share</mat-icon>
      </button>
      <button mat-icon-button class="header-share-button" (click)="fecharDetalhe()" matTooltip="fechar">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content>
      <p class="info-text">{{ selectedEstabelecimento.info }}</p>
      <div class="horario-highlight" *ngIf="getHorarioHoje(selectedEstabelecimento) as horarioHoje">
        <mat-icon class="horario-icon">schedule</mat-icon><span>{{ horarioHoje }}</span>
      </div>
      <ng-container *ngIf="getHorarioHoje(selectedEstabelecimento) as horarioHoje">
        <div class="fornada-highlight" *ngIf="!horarioHoje.toLowerCase().includes('fechado')">
          <mat-icon>bakery_dining</mat-icon><span>Próxima fornada quentinha às <b>{{
              getNextFornada(selectedEstabelecimento.proximaFornada) }}</b></span>
        </div>
      </ng-container>
      <a class="address-container" (click)="iniciarNavegacao(selectedEstabelecimento, $event)" mat-ripple>
        <div class="address-content">
          <mat-icon class="location-icon">location_on</mat-icon>
          <div class="address-text">
            <p>{{ selectedEstabelecimento.endereco.rua }}, {{ selectedEstabelecimento.endereco.numero }}</p>
            <small>Toque para ver a rota</small>
          </div>
        </div>
        <mat-icon>chevron_right</mat-icon>
      </a>
    </mat-card-content>
    <mat-card-actions class="card-actions-wrapper">
      <button mat-flat-button color="primary" class="follow-button"
        (click)="seguirEstabelecimento(selectedEstabelecimento, $event)">
        <mat-icon>notifications</mat-icon> Seguir e receber alertas
      </button>
      <!-- <button mat-button class="close-button" (click)="fecharDetalhe()">Fechar</button> -->
    </mat-card-actions>
  </mat-card>
</div>