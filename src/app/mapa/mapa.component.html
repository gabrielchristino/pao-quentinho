<div class="install-banner" *ngIf="installPrompt && showInstallBanner">
  <div class="install-banner-content">
    <mat-icon>add_to_home_screen</mat-icon>
    <div class="install-banner-text">
      <strong>Instale o Pão Quentinho!</strong>
      <span>Acesse mais rápido, direto da sua tela inicial.</span>
    </div>
    <button mat-flat-button color="primary" (click)="instalarPWA()">Instalar</button>
    <button mat-icon-button (click)="dismissInstallBanner()" aria-label="Dispensar instalação">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>
<div class="map-container">
  <!-- Overlay de Carregamento -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p class="loading-text">Localizando você e buscando os melhores pães...</p>
  </div>


  <div #map id="map"></div>

  <mat-button-toggle-group class="radius-filter" [value]="raio" (change)="definirRaio($event.value)" *ngIf="!routingControl">
    <mat-button-toggle [value]="500">500m</mat-button-toggle>
    <mat-button-toggle [value]="1000">1km</mat-button-toggle>
    <mat-button-toggle [value]="5000">5km</mat-button-toggle>
  </mat-button-toggle-group>

  <!-- Botão para Sair da Rota -->
  <button
    mat-fab extended
    color="warn"
    class="exit-route-button"
    *ngIf="routingControl"
    (click)="fecharDetalhe()"
  >
    <mat-icon>close</mat-icon>
    Sair da Navegação
  </button>

</div>

<!-- Bottom Sheet customizado -->
<div
  id="bottomSheet"
  [class.open]="isListOpen"
  *ngIf="!routingControl && !isLoading"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd($event)"
>
  <div class="handle" (click)="alternarLista()">
    <div class="handle-bar"></div>
  </div>
  <div class="sheet-content">
    <h4 class="sheet-title" *ngIf="estabelecimentosVisiveis.length > 0; else noResults">
      Exibindo {{ estabelecimentosVisiveis.length }} de {{ todosEstabelecimentos.length }} locais
    </h4>
    <ng-template #noResults>
      <h4 class="sheet-title">Nenhum local encontrado neste raio.</h4>
    </ng-template>
    <mat-nav-list>
      <a mat-list-item *ngFor="let est of estabelecimentosVisiveis" (click)="selecionarEstabelecimento(est)" class="establishment-list-item">
        <mat-icon matListItemIcon class="list-item-icon">
          @switch (est.tipo) {
            @case ('padaria') { bakery_dining }
            @case ('confeitaria') { cake }
            @case ('doceria') { icecream }
            @default { storefront }
          }
        </mat-icon>
        <div matListItemTitle class="list-item-title">{{ est.nome }}</div>
        <div matListItemLine class="list-item-line">{{ est.tipo }}</div>
        <span class="list-item-spacer"></span>
        <div matListItemMeta class="distancia-meta">{{ (est.distanciaKm ?? 0).toFixed(2) }} km</div>
      </a>
    </mat-nav-list>
  </div>
</div>

<!-- Card de Detalhes do Estabelecimento -->
<div class="establishment-details-container" *ngIf="selectedEstabelecimento" (click)="fecharDetalhe()">
  <mat-card class="establishment-card" (click)="$event.stopPropagation()">
    <mat-card-header>
      <div class="header-text-content">
        <mat-card-title>{{ selectedEstabelecimento.nome }}</mat-card-title>
        <mat-card-subtitle>{{ selectedEstabelecimento.endereco.bairro }} - {{ (selectedEstabelecimento.distanciaKm ?? 0).toFixed(2) }} km</mat-card-subtitle>
      </div>
      <button mat-icon-button class="header-share-button" (click)="compartilharEstabelecimento(selectedEstabelecimento, $event)" matTooltip="Compartilhar este local">
        <mat-icon>share</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content>

      <!-- Destaque da Próxima Fornada -->
      <div class="fornada-highlight">
        <mat-icon>bakery_dining</mat-icon>
        <span>Próxima fornada quentinha às <b>{{ getNextFornada(selectedEstabelecimento.proximaFornada) }}</b></span>
      </div>

      <!-- Informações -->
      <p class="info-text">{{ selectedEstabelecimento.info }}</p>

      <!-- Endereço Clicável -->
      <a class="address-container" (click)="iniciarNavegacao(selectedEstabelecimento, $event)" mat-ripple>
        <div class="address-content">
          <mat-icon class="location-icon">location_on</mat-icon>
          <div class="address-text">
            <p>{{ selectedEstabelecimento.endereco.rua }}, {{ selectedEstabelecimento.endereco.numero }}</p>
            <small>Toque para ver a rota</small>
          </div>
        </div>
        <mat-icon>chevron_right</mat-icon>
      </a>

    </mat-card-content>
    <mat-card-actions class="card-actions-wrapper">
      <button mat-flat-button color="primary" class="follow-button" (click)="seguirEstabelecimento(selectedEstabelecimento, $event)">
        <mat-icon>notifications</mat-icon>
        Seguir e receber alertas
      </button>
      <button mat-button class="close-button" (click)="fecharDetalhe()">Fechar</button>
    </mat-card-actions>
  </mat-card>
</div>
